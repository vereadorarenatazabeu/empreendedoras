<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family:'Roboto',Arial,sans-serif; background:#fff; margin:0; padding:0; }
    .top-image { width:100%; max-height:650px; overflow:hidden; }
    .top-image img { width:100%; height:auto; display:block; }
    form { 
      background:rgba(255,255,255,0.98); 
      padding:25px; 
      border-radius:8px; 
      margin:20px auto; 
      box-shadow:0 2px 6px rgba(0,0,0,0.15); 
    }
    label { 
      display: flex; 
      flex-direction: column; 
      font-weight: 500;
      margin-bottom: 15px;
    }
    input, select { 
      padding: 10px; 
      border-radius: 4px; 
      border: 1px solid #ccc; 
      font-size: 14px; 
      width: 100%; 
      box-sizing: border-box; 
      margin-top: 5px;
    }
    .file-wrapper { position:relative; overflow:hidden; }
    .file-wrapper input[type="file"] { width:100%; padding:12px; font-size:14px; cursor:pointer; opacity:1; }
    input[type=submit] { 
      width: 100%; 
      padding: 12px; 
      font-size: 16px; 
      background: #1a73e8; 
      color: #fff; 
      border: none; 
      cursor: pointer; 
      margin-top: 15px;
    }
    input[type=submit]:hover { background:#1669c1; }
    input[type=submit]:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .msg { text-align:center; color:green; font-weight:bold; margin-top:10px; }
    #outroSegmentoDiv { display:none; margin-top:5px; }
    .cep-status { font-size: 12px; margin-top: 2px; }
    .loading { color: #1a73e8; }
    .error { color: #d32f2f; }
    .success { color: #388e3c; }
  </style>

  <script>
    function mascarar(input,tipo){
      let v = input.value.replace(/\D/g,'');
      if(tipo==='cep'){ 
        if(v.length>5)v=v.slice(0,5)+'-'+v.slice(5,8); 
        input.value=v;
      }
      else if(tipo==='whatsapp'){
        if(v.length>11)v=v.slice(0,11);
        if(v.length>6) input.value='('+v.slice(0,2)+') '+v.slice(2,7)+'-'+v.slice(7);
        else if(v.length>2) input.value='('+v.slice(0,2)+') '+v.slice(2);
        else input.value=v;
      }
      else if(tipo==='dataNascimento'){
        if(v.length>8) v=v.slice(0,8);
        if(v.length>4) v=v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4,8);
        else if(v.length>2) v=v.slice(0,2)+'/'+v.slice(2,4);
        input.value=v;
      }
    }

    function buscarCep(){
      const cepInput = document.getElementById('cep');
      const enderecoInput = document.getElementById('endereco');
      const bairroInput = document.getElementById('bairro');
      
      if(!cepInput || !enderecoInput || !bairroInput) return;
      
      const cep = cepInput.value.replace(/\D/g,'');
      if(cep.length !== 8) return;

      enderecoInput.value = '';
      bairroInput.value = '';

      let statusElement = document.getElementById('cep-status');
      if(!statusElement) {
        statusElement = document.createElement('div');
        statusElement.id = 'cep-status';
        cepInput.parentNode.appendChild(statusElement);
      }
      statusElement.className = 'cep-status loading';
      statusElement.textContent = 'Buscando endereço...';

      // Bloqueia os campos de endereço enquanto a busca acontece
      enderecoInput.disabled = true;
      bairroInput.disabled = true;

      google.script.run
        .withSuccessHandler(res => {
          // Desbloqueia os campos após a busca
          enderecoInput.disabled = false;
          bairroInput.disabled = false;
          
          if (res.erro) {
            statusElement.className = 'cep-status error';
            statusElement.textContent = 'CEP não encontrado';
          } else {
            enderecoInput.value = res.endereco || '';
            bairroInput.value = res.bairro || '';
            statusElement.className = 'cep-status success';
            statusElement.textContent = '✓ Endereço encontrado';
            setTimeout(() => statusElement.remove(), 3000);
          }
        })
        .withFailureHandler(err => {
          // Desbloqueia os campos após o erro
          enderecoInput.disabled = false;
          bairroInput.disabled = false;
          
          console.error('Erro na chamada do servidor:', err);
          statusElement.className = 'cep-status error';
          statusElement.textContent = 'Erro ao buscar CEP. Verifique o console.';
        })
        .buscarCepServer(cep);
    }

    function mostrarOutro(){
      const select=document.getElementById('segmento');
      const div=document.getElementById('outroSegmentoDiv');
      div.style.display = select.value==='Outro' ? 'block' : 'none';
    }

    function validarFormulario(dados){
      if(!dados.nome||!dados.whatsapp||!dados.nomeMarca||!dados.cep||
        !dados.endereco||!dados.bairro||!dados.numero||!dados.segmento||!dados.dataNascimento){ 
        alert('Preencha todos os campos obrigatórios!'); 
        return false; 
      }
      if(dados.cep.replace(/\D/g,'').length!==8){ 
        alert('CEP inválido!'); 
        return false; 
      }
      if(!/^\d{2}\/\d{2}\/\d{4}$/.test(dados.dataNascimento)){
          alert('Data de nascimento inválida. Use o formato DD/MM/AAAA.');
          return false;
      }
      return true;
    }

    function enviarDados(event){
      event.preventDefault();
      
      const fileInput=document.getElementById('logo');
      const file=fileInput.files[0];
      if(file && file.size>5*1024*1024){ 
        alert('Arquivo muito grande! Máx:5MB'); 
        return; 
      }

      const dados = coletarDados();
      if(!validarFormulario(dados)) return;

      // Bloqueia o botão para evitar cliques múltiplos
      const submitButton = document.querySelector('input[type="submit"]');
      submitButton.disabled = true;
      submitButton.value = 'Enviando...';

      // Define uma função de retorno para o sucesso, que reabilita o botão
      const handleSuccess = (msg) => {
        document.getElementById('msg').innerText = msg;
        document.querySelector('form').reset();
        mostrarOutro();
        // Reabilita o botão após a conclusão
        submitButton.disabled = false;
        submitButton.value = 'Enviar';
      };

      if(file){
        const reader = new FileReader();
        reader.onload=function(e){
          const base64=e.target.result.split(',')[1];
          const fileObj={ base64:base64, mimeType:file.type, name:file.name };
          google.script.run
            .withSuccessHandler(handleSuccess)
            .withFailureHandler(() => {
              alert('Erro ao enviar o formulário.');
              submitButton.disabled = false;
              submitButton.value = 'Enviar';
            })
            .enviarFormulario(dados,fileObj);
        };
        reader.readAsDataURL(file);
      } else {
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(() => {
            alert('Erro ao enviar o formulário.');
            submitButton.disabled = false;
            submitButton.value = 'Enviar';
          })
          .enviarFormulario(dados,null);
      }
    }

    function coletarDados() {
      const segmento = document.getElementById('segmento').value==='Outro' 
        ? document.getElementById('outroSegmento').value.trim() 
        : document.getElementById('segmento').value;

      return {
        nome:document.getElementById('nome').value.trim(),
        dataNascimento:document.getElementById('dataNascimento').value.trim(),
        whatsapp:document.getElementById('whatsapp').value.trim(),
        nomeMarca:document.getElementById('nomemarca').value.trim(),
        cep:document.getElementById('cep').value.trim(),
        endereco:document.getElementById('endereco').value.trim(),
        bairro:document.getElementById('bairro').value.trim(),
        numero:document.getElementById('numero').value.trim(),
        segmento:segmento,
        instagram:document.getElementById('instagram').value.trim()
      };
    }
  </script>
</head>

<body>
  <div class="top-image"><img src="https://i.imgur.com/KjBEni2.jpeg" alt="Imagem Topo"></div>

  <form onsubmit="enviarDados(event)">
    <label>Nome: <input type="text" id="nome" required></label>
    <label>Data de nascimento: <input type="text" id="dataNascimento" required oninput="mascarar(this,'dataNascimento')" placeholder="dd/mm/aaaa"></label>
    <label>WhatsApp: <input type="text" id="whatsapp" required oninput="mascarar(this,'whatsapp')" placeholder="(99) 99999-9999"></label>
    <label>Nome da marca/empresa: <input type="text" id="nomemarca" required></label>
    <label>CEP: 
      <input type="text" id="cep" required oninput="mascarar(this,'cep')" onblur="buscarCep()" placeholder="Somente números"></label>
    <label>Endereço: <input type="text" id="endereco" required></label>
    <label>Bairro: <input type="text" id="bairro" required></label>
    <label>Número: <input type="text" id="numero" required></label>

    <label>Segmento:
      <select id="segmento" onchange="mostrarOutro()">
        <option>Artesanato</option>
        <option>Moda</option>
        <option>Gastronomia</option>
        <option>Beleza</option>
        <option>Serviços</option>
        <option>Outro</option>
      </select>
    </label>
    <div id="outroSegmentoDiv">
      <input type="text" id="outroSegmento" placeholder="Descreva o outro segmento">
    </div>

    <label>Instagram: <input type="text" id="instagram"></label>

    <label class="file-wrapper">Logo da empresa:
      <input type="file" id="logo" accept="image/*">
    </label>

    <input type="submit" value="Enviar">
    <div id="msg" class="msg"></div>
  </form>
</body>
</html>
